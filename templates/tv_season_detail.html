{% extends "base.html" %}

{% block title %}{{ show_name }} - Season {{ season_number }} - FrameIQ{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-indigo-900 py-8">
    <div class="container mx-auto px-4 max-w-6xl">
        <!-- Breadcrumb Navigation -->
        <div class="mb-6">
            <nav class="flex items-center gap-2 text-sm text-gray-400">
                <a href="/" class="hover:text-white transition-colors">Home</a>
                <span>‚Ä∫</span>
                <a href="/tv_shows" class="hover:text-white transition-colors">TV Shows</a>
                <span>‚Ä∫</span>
                <a href="/tv/{{ show_id }}" class="hover:text-white transition-colors">{{ show_name }}</a>
                <span>‚Ä∫</span>
                <span class="text-white">Season {{ season_number }}</span>
            </nav>
        </div>

        <!-- Season Header -->
        <div class="bg-white/5 backdrop-blur-md rounded-xl p-6 mb-8 border border-white/10">
            <div class="flex gap-6">
                <!-- Season Poster -->
                <div class="flex-shrink-0">
                    <img id="season-poster" 
                         src="/static/images/no-poster.png" 
                         alt="Season {{ season_number }}"
                         class="w-48 h-72 rounded-lg object-cover shadow-2xl">
                </div>

                <!-- Season Info -->
                <div class="flex-1">
                    <h1 class="text-4xl font-bold text-white mb-2" id="season-title">
                        Loading...
                    </h1>
                    <div class="flex flex-wrap gap-4 text-gray-300 mb-4">
                        <span id="episode-count"></span>
                        <span id="air-date"></span>
                        <span id="season-rating"></span>
                    </div>
                    
                    <p id="season-overview" class="text-gray-300 mb-6"></p>
                    
                    <!-- Progress Stats -->
                    <div class="bg-white/10 rounded-lg p-4 mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-white font-semibold">Your Progress</span>
                            <span id="progress-text" class="text-indigo-300">0/0 Episodes</span>
                        </div>
                        <div class="h-3 bg-gray-700 rounded-full overflow-hidden">
                            <div id="progress-bar" class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex flex-wrap gap-3">
                        <button id="mark-season-watched-btn" class="px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white rounded-lg font-semibold transition-all transform hover:scale-105 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            Mark All Watched
                        </button>
                        <button id="unmark-season-btn" class="hidden px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg font-semibold transition-all flex items-center gap-2">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                            Unmark All
                        </button>
                        <a href="/tv/{{ show_id }}" class="px-6 py-3 bg-white/10 hover:bg-white/20 text-white rounded-lg font-semibold transition-all flex items-center gap-2">
                            ‚Üê Back to Show
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Episodes List -->
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-white mb-4 flex items-center gap-2">
                <svg class="w-6 h-6 text-indigo-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"/>
                </svg>
                Episodes
            </h2>
        </div>

        <div id="episodes-list" class="space-y-4">
            <div class="flex justify-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"></div>
            </div>
        </div>
    </div>
</div>

<script>
const TMDB_API_KEY = '{{ api_key }}';
const SHOW_ID = {{ show_id }};
const SEASON_NUMBER = {{ season_number }};
let seasonData = null;
let watchedEpisodes = new Set();

async function loadSeasonData() {
    try {
        // Load season details from TMDb
        const response = await fetch(
            `https://api.themoviedb.org/3/tv/${SHOW_ID}/season/${SEASON_NUMBER}?api_key=${TMDB_API_KEY}`
        );
        seasonData = await response.json();
        
        // Load show name
        const showResponse = await fetch(
            `https://api.themoviedb.org/3/tv/${SHOW_ID}?api_key=${TMDB_API_KEY}`
        );
        const showData = await showResponse.json();
        
        // Load watched episodes
        await loadWatchedEpisodes();
        
        // Render UI
        renderSeasonHeader(showData);
        renderEpisodes();
        
    } catch (error) {
        console.error('Error loading season data:', error);
        document.getElementById('episodes-list').innerHTML = `
            <div class="text-center py-12">
                <p class="text-red-400">Error loading season data</p>
            </div>
        `;
    }
}

async function loadWatchedEpisodes() {
    try {
        const response = await fetch(`/api/tv/${SHOW_ID}/watched-episodes`);
        const data = await response.json();
        if (data.success) {
            watchedEpisodes.clear();
            data.episodes.forEach(ep => {
                if (ep.season_number === SEASON_NUMBER) {
                    watchedEpisodes.add(ep.episode_number);
                }
            });
        }
    } catch (error) {
        console.error('Error loading watched episodes:', error);
    }
}

function renderSeasonHeader(showData) {
    // Update poster
    if (seasonData.poster_path) {
        document.getElementById('season-poster').src = `https://image.tmdb.org/t/p/w500${seasonData.poster_path}`;
    }
    
    // Update title
    document.getElementById('season-title').textContent = seasonData.name || `Season ${SEASON_NUMBER}`;
    
    // Update stats
    document.getElementById('episode-count').innerHTML = `<strong>${seasonData.episodes.length}</strong> Episodes`;
    
    if (seasonData.air_date) {
        document.getElementById('air-date').innerHTML = `<strong>Aired:</strong> ${new Date(seasonData.air_date).getFullYear()}`;
    }
    
    if (seasonData.vote_average) {
        document.getElementById('season-rating').innerHTML = `‚≠ê <strong>${seasonData.vote_average.toFixed(1)}</strong>`;
    }
    
    // Update overview
    if (seasonData.overview) {
        document.getElementById('season-overview').textContent = seasonData.overview;
    }
    
    // Update progress
    updateProgress();
    
    // Setup buttons
    document.getElementById('mark-season-watched-btn').onclick = markSeasonWatched;
    document.getElementById('unmark-season-btn').onclick = unmarkSeasonWatched;
}

function updateProgress() {
    const total = seasonData.episodes.length;
    const watched = watchedEpisodes.size;
    const percentage = (watched / total) * 100;
    
    document.getElementById('progress-text').textContent = `${watched}/${total} Episodes`;
    document.getElementById('progress-bar').style.width = `${percentage}%`;
    
    // Show/hide buttons
    if (watched === total) {
        document.getElementById('mark-season-watched-btn').classList.add('hidden');
        document.getElementById('unmark-season-btn').classList.remove('hidden');
    } else {
        document.getElementById('mark-season-watched-btn').classList.remove('hidden');
        document.getElementById('unmark-season-btn').classList.add('hidden');
    }
}

function renderEpisodes() {
    const container = document.getElementById('episodes-list');
    
    container.innerHTML = seasonData.episodes.map(episode => {
        const isWatched = watchedEpisodes.has(episode.episode_number);
        
        return `
            <div class="bg-white/5 hover:bg-white/10 rounded-xl overflow-hidden transition-all border border-white/10 ${isWatched ? 'opacity-75' : ''}">
                <div class="flex gap-4 p-4">
                    <!-- Episode Still -->
                    <div class="flex-shrink-0 cursor-pointer" onclick="window.location.href='/tv/${SHOW_ID}/season/${SEASON_NUMBER}/episode/${episode.episode_number}'">
                        <img src="${episode.still_path ? `https://image.tmdb.org/t/p/w300${episode.still_path}` : '/static/images/no-image.png'}" 
                             alt="Episode ${episode.episode_number}"
                             class="w-48 h-27 rounded-lg object-cover hover:ring-2 hover:ring-indigo-500 transition-all">
                        ${isWatched ? `
                            <div class="absolute top-2 left-2 bg-green-500 text-white px-2 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                                Watched
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Episode Info -->
                    <div class="flex-1">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="text-xl font-bold text-white hover:text-indigo-400 cursor-pointer"
                                    onclick="window.location.href='/tv/${SHOW_ID}/season/${SEASON_NUMBER}/episode/${episode.episode_number}'">
                                    ${episode.episode_number}. ${episode.name}
                                </h3>
                                <div class="flex flex-wrap gap-3 text-sm text-gray-400 mt-1">
                                    ${episode.air_date ? `<span>üìÖ ${new Date(episode.air_date).toLocaleDateString()}</span>` : ''}
                                    ${episode.runtime ? `<span>‚è±Ô∏è ${episode.runtime}min</span>` : ''}
                                    ${episode.vote_average ? `<span>‚≠ê ${episode.vote_average.toFixed(1)}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <p class="text-gray-300 text-sm mb-3 line-clamp-2">${episode.overview || 'No overview available.'}</p>
                        
                        <!-- Action Buttons -->
                        <div class="flex flex-wrap gap-2">
                            ${!isWatched ? `
                                <button onclick="markEpisodeWatched(${episode.episode_number})"
                                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-semibold transition-all flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                    </svg>
                                    Mark Watched
                                </button>
                            ` : `
                                <button onclick="unmarkEpisodeWatched(${episode.episode_number})"
                                        class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm font-semibold transition-all flex items-center gap-2">
                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                                    </svg>
                                    Unmark
                                </button>
                            `}
                            
                            <button onclick="window.location.href='/tv/${SHOW_ID}/season/${SEASON_NUMBER}/episode/${episode.episode_number}'"
                                    class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-semibold transition-all flex items-center gap-2">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                    <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                                </svg>
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

async function markEpisodeWatched(episodeNumber) {
    try {
        console.log(`Marking episode ${episodeNumber} as watched...`);
        const response = await fetch(`/api/tv/${SHOW_ID}/episode/${SEASON_NUMBER}/${episodeNumber}/mark-watched?_=${Date.now()}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);
        
        if (response.ok && data.success) {
            watchedEpisodes.add(episodeNumber);
            updateProgress();
            renderEpisodes();
            showNotification('‚úì Episode marked as watched!', 'success');
        } else {
            console.error('Failed response:', data);
            showNotification(data.error || 'Failed to mark episode', 'error');
        }
    } catch (error) {
        console.error('Error marking episode watched:', error);
        showNotification('Failed to mark episode: ' + error.message, 'error');
    }
}

async function unmarkEpisodeWatched(episodeNumber) {
    try {
        console.log(`Unmarking episode ${episodeNumber}...`);
        const response = await fetch(`/api/tv/${SHOW_ID}/episode/${SEASON_NUMBER}/${episodeNumber}/unmark-watched?_=${Date.now()}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);
        
        if (response.ok && data.success) {
            watchedEpisodes.delete(episodeNumber);
            updateProgress();
            renderEpisodes();
            showNotification('Episode unmarked', 'success');
        } else {
            console.error('Failed response:', data);
            showNotification(data.error || 'Failed to unmark episode', 'error');
        }
    } catch (error) {
        console.error('Error unmarking episode:', error);
        showNotification('Failed to unmark episode: ' + error.message, 'error');
    }
}

async function markSeasonWatched() {
    if (!confirm(`Mark all ${seasonData.episodes.length} episodes as watched?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/tv/${SHOW_ID}/season/${SEASON_NUMBER}/mark-watched`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            await loadWatchedEpisodes();
            updateProgress();
            renderEpisodes();
            showNotification('‚úì Season completed!', 'success');
        }
    } catch (error) {
        console.error('Error marking season watched:', error);
        showNotification('Failed to mark season', 'error');
    }
}

async function unmarkSeasonWatched() {
    if (!confirm('Unmark all episodes in this season?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/tv/${SHOW_ID}/season/${SEASON_NUMBER}/unmark-watched`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (data.success) {
            await loadWatchedEpisodes();
            updateProgress();
            renderEpisodes();
            showNotification('Season unmarked', 'success');
        }
    } catch (error) {
        console.error('Error unmarking season:', error);
        showNotification('Failed to unmark season', 'error');
    }
}

function showNotification(message, type = 'info') {
    const colors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        info: 'bg-indigo-500'
    };

    const notification = document.createElement('div');
    notification.className = `fixed bottom-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Load data on page load
loadSeasonData();
</script>
{% endblock %}
