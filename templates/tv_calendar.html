{% extends "base.html" %}

{% block title %}TV Episode Calendar - FrameIQ{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-indigo-900 py-8">
    <div class="container mx-auto px-4">
        <!-- Breadcrumb Navigation -->
        <div class="mb-6">
            <nav class="flex items-center gap-2 text-sm text-gray-400">
                <a href="/" class="hover:text-white transition-colors">Home</a>
                <span>‚Ä∫</span>
                <a href="/tv/dashboard" class="hover:text-white transition-colors">TV Dashboard</a>
                <span>‚Ä∫</span>
                <span class="text-white">Calendar</span>
            </nav>
        </div>

        <!-- Quick Links -->
        <div class="flex flex-wrap gap-3 mb-6">
            <a href="/tv/dashboard" class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-white transition-all flex items-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                </svg>
                Dashboard
            </a>
            <a href="/tv/my-shows" class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-white transition-all flex items-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"/>
                </svg>
                My Shows
            </a>
            <a href="/tv_shows" class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/10 rounded-lg text-white transition-all flex items-center gap-2">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/>
                    <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/>
                </svg>
                Browse Shows
            </a>
        </div>

        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">
                üìÖ TV Episode Calendar
            </h1>
            <p class="text-gray-300 text-lg">
                Track upcoming episodes from your watched shows
            </p>
        </div>

        <!-- Date Navigation -->
        <div class="flex justify-between items-center mb-6 bg-white/10 backdrop-blur-md rounded-xl p-4">
            <button id="prevWeek" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                ‚Üê Previous Week
            </button>
            <div class="text-white font-semibold text-lg" id="dateRange">
                Loading...
            </div>
            <button id="nextWeek" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                Next Week ‚Üí
            </button>
        </div>

        <!-- Calendar Grid -->
        <div id="calendarGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <!-- Calendar days will be inserted here -->
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mx-auto"></div>
            <p class="text-white mt-4">Loading calendar...</p>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden text-center py-12 bg-white/10 backdrop-blur-md rounded-xl">
            <div class="text-6xl mb-4">üì∫</div>
            <h3 class="text-xl font-semibold text-white mb-2">No Upcoming Episodes</h3>
            <p class="text-gray-300 mb-4">
                Start tracking TV shows to see upcoming episodes here
            </p>
            <a href="/tv_shows" class="inline-block px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                Browse TV Shows
            </a>
        </div>
    </div>
</div>

<style>
.episode-card {
    transition: transform 0.2s;
}
.episode-card:hover {
    transform: translateY(-2px);
}
</style>

<script>
let currentStartDate = new Date();
currentStartDate.setHours(0, 0, 0, 0);

function formatDate(date) {
    return date.toISOString().split('T')[0];
}

function formatDisplayDate(dateStr) {
    const date = new Date(dateStr);
    const options = { weekday: 'short', month: 'short', day: 'numeric' };
    return date.toLocaleDateString('en-US', options);
}

function loadCalendar() {
    const endDate = new Date(currentStartDate);
    endDate.setDate(endDate.getDate() + 7);

    // Update date range display
    document.getElementById('dateRange').textContent = 
        `${formatDisplayDate(formatDate(currentStartDate))} - ${formatDisplayDate(formatDate(endDate))}`;

    // Show loading
    document.getElementById('loadingState').classList.remove('hidden');
    document.getElementById('calendarGrid').classList.add('hidden');
    document.getElementById('emptyState').classList.add('hidden');

    fetch(`/api/tv/calendar?start_date=${formatDate(currentStartDate)}&end_date=${formatDate(endDate)}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('loadingState').classList.add('hidden');
            
            if (Object.keys(data.calendar).length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }

            renderCalendar(data.calendar);
        })
        .catch(error => {
            console.error('Error loading calendar:', error);
            document.getElementById('loadingState').classList.add('hidden');
            alert('Failed to load calendar');
        });
}

function renderCalendar(calendar) {
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';
    grid.classList.remove('hidden');

    // Create day cards for the week
    for (let i = 0; i < 7; i++) {
        const date = new Date(currentStartDate);
        date.setDate(date.getDate() + i);
        const dateKey = formatDate(date);
        const episodes = calendar[dateKey] || [];

        const dayCard = document.createElement('div');
        dayCard.className = 'bg-white/10 backdrop-blur-md rounded-xl p-4';

        const isToday = formatDate(new Date()) === dateKey;
        const dayHeader = `
            <div class="mb-3 pb-2 border-b border-white/20">
                <div class="text-white font-semibold text-lg ${isToday ? 'text-yellow-400' : ''}">
                    ${formatDisplayDate(dateKey)} ${isToday ? '(Today)' : ''}
                </div>
                <div class="text-gray-400 text-sm">
                    ${episodes.length} episode${episodes.length !== 1 ? 's' : ''}
                </div>
            </div>
        `;

        let episodesHtml = '';
        if (episodes.length === 0) {
            episodesHtml = '<div class="text-gray-400 text-sm italic">No episodes airing</div>';
        } else {
            episodes.forEach(ep => {
                episodesHtml += `
                    <div class="episode-card bg-white/5 rounded-lg p-3 mb-2 cursor-pointer hover:bg-white/10" 
                         onclick="window.location.href='/tv/${ep.show_id}'">
                        <div class="flex items-start gap-3">
                            ${ep.still_path ? `
                                <img src="https://image.tmdb.org/t/p/w200${ep.still_path}" 
                                     alt="${ep.episode_name}"
                                     class="w-16 h-10 rounded object-cover">
                            ` : '<div class="w-16 h-10 bg-gray-700 rounded flex items-center justify-center text-xs text-gray-400">No image</div>'}
                            <div class="flex-1 min-w-0">
                                <div class="text-white font-medium text-sm truncate">
                                    ${ep.show_name}
                                </div>
                                <div class="text-indigo-300 text-xs">
                                    S${ep.season_number}E${ep.episode_number}
                                    ${ep.air_time ? ` ‚Ä¢ ${ep.air_time}` : ''}
                                </div>
                                <div class="text-gray-300 text-xs mt-1 truncate">
                                    ${ep.episode_name || 'TBA'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        dayCard.innerHTML = dayHeader + episodesHtml;
        grid.appendChild(dayCard);
    }
}

// Navigation
document.getElementById('prevWeek').addEventListener('click', () => {
    currentStartDate.setDate(currentStartDate.getDate() - 7);
    loadCalendar();
});

document.getElementById('nextWeek').addEventListener('click', () => {
    currentStartDate.setDate(currentStartDate.getDate() + 7);
    loadCalendar();
});

// Initial load
loadCalendar();

// Refresh every 5 minutes
setInterval(loadCalendar, 5 * 60 * 1000);
</script>
{% endblock %}
